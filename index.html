<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Dictionary - A1 Elementary Level</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDzR98RZOjAy4MDKqM6jfYYL_HvLkMfDho",
            authDomain: "english-dictionary-915aa.firebaseapp.com",
            databaseURL: "https://english-dictionary-915aa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "english-dictionary-915aa",
            storageBucket: "english-dictionary-915aa.firebasestorage.app",
            messagingSenderId: "903752983791",
            appId: "1:903752983791:web:0c5aa74b30cd3463c3271a"
        };

        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
    </script>
    
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .loader {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 min-h-screen">
    <!-- History Toggle Button (Mobile) -->
    <button 
        onclick="toggleHistory()" 
        class="fixed top-4 right-4 z-50 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-3 rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all md:hidden"
    >
        <span class="text-2xl">ğŸ“š</span>
    </button>

    <!-- Secret Code Modal -->
    <div id="secretCodeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <span class="mr-2">ğŸ”‘</span>
                Secret Code
            </h2>
            <p class="text-gray-600 mb-6">áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ£áƒœáƒ˜áƒ™áƒáƒšáƒ£áƒ áƒ˜ áƒ™áƒáƒ“áƒ˜ áƒ áƒáƒ› áƒ¡áƒ˜áƒœáƒ¥áƒ áƒáƒœáƒ˜áƒ–áƒ“áƒ”áƒ¡ áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ áƒ§áƒ•áƒ”áƒšáƒ áƒ›áƒáƒ¬áƒ§áƒáƒ‘áƒ˜áƒšáƒáƒ‘áƒáƒ–áƒ”.</p>
            
            <input 
                type="text" 
                id="secretCodeInput" 
                placeholder="áƒ¨áƒ”áƒ˜áƒ§áƒ•áƒáƒœáƒ”áƒ— 6-áƒœáƒ˜áƒ¨áƒœáƒ áƒ™áƒáƒ“áƒ˜..." 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 mb-4 text-center text-lg font-mono"
                maxlength="6"
            >
            
            <div class="flex gap-3">
                <button 
                    onclick="saveSecretCode()" 
                    class="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transition-all"
                >
                    áƒ¨áƒ”áƒœáƒáƒ®áƒ•áƒ
                </button>
                <button 
                    onclick="generateSecretCode()" 
                    class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl font-semibold hover:bg-gray-300 transition-all"
                >
                    ğŸ² áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ
                </button>
            </div>
            
            <p class="text-xs text-gray-500 mt-4 text-center">
                áƒ”áƒ¡ áƒ™áƒáƒ“áƒ˜ áƒ’áƒ­áƒ˜áƒ áƒ“áƒ”áƒ‘áƒáƒ— áƒ¡áƒ®áƒ•áƒ áƒ›áƒáƒ¬áƒ§áƒáƒ‘áƒ˜áƒšáƒáƒ‘áƒáƒ–áƒ”áƒª áƒ¨áƒ”áƒ¡áƒáƒ§áƒ•áƒáƒœáƒáƒ“
            </p>
        </div>
    </div>

    <!-- History Sidebar -->
    <div id="historySidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-40 overflow-y-auto">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <span class="mr-2">ğŸ“–</span>
                    áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ
                </h2>
                <button 
                    onclick="toggleHistory()" 
                    class="text-gray-500 hover:text-gray-700 text-2xl"
                >
                    âœ•
                </button>
            </div>
            
            <div class="mb-4 bg-blue-50 rounded-lg p-3">
                <p class="text-xs text-gray-600 mb-2">ğŸ”‘ áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒ™áƒáƒ“áƒ˜:</p>
                <div class="flex items-center justify-between">
                    <code id="displaySecretCode" class="text-sm font-mono font-bold text-blue-600">------</code>
                    <button 
                        onclick="showSecretCodeModal()" 
                        class="text-xs text-blue-600 hover:text-blue-800 font-semibold"
                    >
                        áƒ¨áƒ”áƒªáƒ•áƒšáƒ
                    </button>
                </div>
            </div>
            
            <div class="mb-4 flex justify-between items-center">
                <p class="text-sm text-gray-600">áƒ›áƒáƒ«áƒ”áƒ‘áƒœáƒ˜áƒšáƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ”áƒ‘áƒ˜</p>
                <button 
                    onclick="clearHistory()" 
                    class="text-xs text-red-500 hover:text-red-700 font-semibold"
                >
                    áƒ¬áƒáƒ¨áƒšáƒ
                </button>
            </div>

            <div id="historyList" class="space-y-2">
                <!-- History items will be inserted here -->
            </div>

            <div id="emptyHistory" class="text-center py-8 text-gray-400">
                <p class="text-4xl mb-2">ğŸ“š</p>
                <p>áƒ¯áƒ”áƒ  áƒáƒ  áƒ›áƒáƒ’áƒ˜áƒ«áƒ”áƒ‘áƒœáƒ˜áƒáƒ— áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ”áƒ‘áƒ˜</p>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div id="historyOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden" onclick="toggleHistory()"></div>

    <div class="container mx-auto px-4 py-8 md:py-12">
        <!-- Header -->
        <header class="text-center mb-8 md:mb-12">
            <div class="flex items-center justify-center gap-4 mb-3">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600">
                    ğŸ“š English Dictionary
                </h1>
                <button 
                    onclick="toggleHistory()" 
                    class="hidden md:block bg-white hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg shadow-md hover:shadow-lg transition-all border-2 border-gray-200 font-semibold"
                >
                    ğŸ“– áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ
                </button>
            </div>
            <p class="text-gray-600 text-lg md:text-xl">A1 Elementary Level - Learn English Simply</p>
        </header>

        <!-- Search Card -->
        <div class="max-w-3xl mx-auto mb-8">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input 
                        type="text" 
                        id="wordInput" 
                        placeholder="Type an English word..." 
                        class="flex-1 px-6 py-4 text-lg border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
                        onkeypress="if(event.key === 'Enter') searchWord()"
                    >
                    <button 
                        onclick="searchWord()" 
                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all shadow-lg hover:shadow-xl"
                    >
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="hidden text-center mb-8">
            <div class="loader mx-auto"></div>
            <p class="text-gray-600 mt-4">Searching for definition...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="hidden max-w-3xl mx-auto mb-8">
            <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 fade-in">
                <div class="flex items-center">
                    <span class="text-3xl mr-3">âš ï¸</span>
                    <div>
                        <h3 class="font-bold text-red-800 text-lg">Error</h3>
                        <p class="text-red-700" id="errorText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="hidden max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-6 md:p-10 fade-in">
                <!-- Word Title -->
                <div class="border-b-2 border-gray-100 pb-6 mb-6">
                    <!-- Spelling Correction Notice -->
                    <div id="spellingNotice" class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">ğŸ’¡</span>
                            <div>
                                <p class="text-sm text-yellow-800">
                                    <span class="font-semibold">Did you mean:</span> 
                                    <span id="correctedWord" class="font-bold text-yellow-900"></span>?
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 mb-2">
                        <h2 id="wordTitle" class="text-3xl md:text-4xl font-bold text-gray-800"></h2>
                        <button 
                            onclick="speakWord()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-full shadow-md hover:shadow-lg transition-all transform hover:scale-110"
                            title="áƒ’áƒáƒ›áƒáƒ—áƒ¥áƒ•áƒ"
                        >
                            <span class="text-2xl">ğŸ”Š</span>
                        </button>
                    </div>
                    <span class="inline-block bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm font-semibold">
                        A1 Elementary Level
                    </span>
                </div>

                <!-- Definition Section -->
                <div class="mb-8">
                    <h3 class="flex items-center text-xl md:text-2xl font-semibold text-gray-700 mb-4">
                        <span class="text-2xl mr-2">ğŸ“–</span>
                        Definition
                    </h3>
                    <div class="bg-blue-50 rounded-xl p-5 md:p-6">
                        <p id="definition" class="text-gray-800 text-lg leading-relaxed"></p>
                    </div>
                </div>

                <!-- Examples Section -->
                <div>
                    <h3 class="flex items-center text-xl md:text-2xl font-semibold text-gray-700 mb-4">
                        <span class="text-2xl mr-2">ğŸ’¡</span>
                        Examples
                    </h3>
                    <div class="space-y-4" id="examplesContainer">
                        <!-- Examples will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500">
            <p>Made with â¤ï¸ for English learners</p>
        </footer>
    </div>

    <script>
        let userSecretCode = localStorage.getItem('secretCode');
        let syncEnabled = false;

        // Initialize Firebase sync when page loads
        window.addEventListener('DOMContentLoaded', () => {
            if (!userSecretCode) {
                showSecretCodeModal();
            } else {
                initializeFirebaseSync();
                updateSecretCodeDisplay();
            }
            
            updateHistoryDisplay();
            
            // Check if word is in URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const wordFromUrl = urlParams.get('word') || urlParams.get('q');
            
            if (wordFromUrl) {
                document.getElementById('wordInput').value = wordFromUrl;
                searchWord();
            }
        });

        function showSecretCodeModal() {
            document.getElementById('secretCodeModal').classList.remove('hidden');
        }

        function generateSecretCode() {
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('secretCodeInput').value = code;
        }

        function saveSecretCode() {
            const input = document.getElementById('secretCodeInput').value.trim();
            if (input.length < 4) {
                alert('áƒ™áƒáƒ“áƒ˜ áƒ£áƒœáƒ“áƒ áƒ˜áƒ§áƒáƒ¡ áƒ›áƒ˜áƒœáƒ˜áƒ›áƒ£áƒ› 4 áƒ¡áƒ˜áƒ›áƒ‘áƒáƒšáƒ');
                return;
            }
            
            userSecretCode = input.toUpperCase();
            localStorage.setItem('secretCode', userSecretCode);
            document.getElementById('secretCodeModal').classList.add('hidden');
            
            // Initialize Firebase sync with new code
            initializeFirebaseSync();
            updateSecretCodeDisplay();
            
            // Migrate local history to Firebase
            migrateLocalToFirebase();
        }

        function updateSecretCodeDisplay() {
            document.getElementById('displaySecretCode').textContent = userSecretCode || '------';
        }

        function initializeFirebaseSync() {
            if (!userSecretCode || !window.db) return;
            
            syncEnabled = true;
            const historyRef = window.dbRef(window.db, `users/${userSecretCode}/history`);
            
            // Listen for changes from Firebase
            window.dbOnValue(historyRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const historyArray = Object.values(data).sort((a, b) => 
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                    localStorage.setItem('wordHistory', JSON.stringify(historyArray));
                    updateHistoryDisplay();
                }
            });
        }

        function migrateLocalToFirebase() {
            const localHistory = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            if (localHistory.length > 0 && userSecretCode && window.db) {
                const historyRef = window.dbRef(window.db, `users/${userSecretCode}/history`);
                const historyObj = {};
                localHistory.forEach((item, index) => {
                    historyObj[`word_${Date.now()}_${index}`] = item;
                });
                window.dbSet(historyRef, historyObj);
            }
        }

        async function searchWord() {
            const wordInput = document.getElementById('wordInput');
            const word = wordInput.value.trim().toLowerCase();
            
            if (!word) {
                showError('Please enter a word to search.');
                return;
            }

            // Show loading, hide results and errors
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('resultsCard').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                // Add timeout to fetch request (30 seconds)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const response = await fetch('/api/define', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ word }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch definition');
                }

                // Only update URL and save to history after successful response
                const newUrl = new URL(window.location);
                newUrl.searchParams.set('word', word);
                window.history.pushState({}, '', newUrl);

                // Save to history with corrected word if available
                const wordToSave = data.correctedWord || word;
                saveToHistory(wordToSave, data);
                
                displayResults(word, data);
            } catch (error) {
                if (error.name === 'AbortError') {
                    showError('Request timeout. The API is taking too long to respond. Please try again.');
                } else {
                    showError(error.message || 'An error occurred. Please try again.');
                }
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        let currentWord = '';

        function speakWord(text) {
            const textToSpeak = text || currentWord;
            if (!textToSpeak) return;
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.lang = 'en-US';
            utterance.rate = 0.9; // áƒªáƒáƒ¢áƒ áƒœáƒ”áƒšáƒ
            utterance.pitch = 1;
            
            window.speechSynthesis.speak(utterance);
        }

        function displayResults(word, data) {
            currentWord = data.correctedWord || word;
            
            // Show spelling correction notice if word was corrected
            const spellingNotice = document.getElementById('spellingNotice');
            const correctedWordEl = document.getElementById('correctedWord');
            
            if (data.correctedWord) {
                correctedWordEl.textContent = data.correctedWord;
                spellingNotice.classList.remove('hidden');
                document.getElementById('wordTitle').textContent = data.correctedWord.charAt(0).toUpperCase() + data.correctedWord.slice(1);
            } else {
                spellingNotice.classList.add('hidden');
                document.getElementById('wordTitle').textContent = word.charAt(0).toUpperCase() + word.slice(1);
            }
            
            document.getElementById('definition').textContent = data.definition;

            const examplesContainer = document.getElementById('examplesContainer');
            examplesContainer.innerHTML = '';

            data.examples.forEach((example, index) => {
                const exampleDiv = document.createElement('div');
                exampleDiv.className = 'bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-5 md:p-6 border-l-4 border-purple-400';
                exampleDiv.innerHTML = `
                    <div class="flex items-start">
                        <span class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold mr-4 flex-shrink-0">
                            ${index + 1}
                        </span>
                        <p class="text-gray-800 text-lg leading-relaxed pt-1">${example}</p>
                    </div>
                `;
                examplesContainer.appendChild(exampleDiv);
            });

            document.getElementById('resultsCard').classList.remove('hidden');
            
            // Scroll to results on mobile
            if (window.innerWidth < 768) {
                document.getElementById('resultsCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        // History management functions
        function saveToHistory(word, data) {
            // Check if word already exists in history
            let history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            const existingIndex = history.findIndex(item => item.word.toLowerCase() === word.toLowerCase());
            
            // If word exists, remove it (we'll add it to top)
            if (existingIndex !== -1) {
                history.splice(existingIndex, 1);
            }
            
            const newItem = {
                word: word,
                definition: data.definition,
                examples: data.examples,
                timestamp: new Date().toISOString()
            };
            
            // Add to beginning of array
            history.unshift(newItem);
            history = history.slice(0, 50);
            
            // If Firebase sync is enabled, save to Firebase
            if (syncEnabled && userSecretCode && window.db) {
                const historyRef = window.dbRef(window.db, `users/${userSecretCode}/history`);
                const historyObj = {};
                history.forEach((item, idx) => {
                    historyObj[`word_${Date.now()}_${idx}`] = item;
                });
                window.dbSet(historyRef, historyObj);
            } else {
                // Save to localStorage only
                localStorage.setItem('wordHistory', JSON.stringify(history));
                updateHistoryDisplay();
            }
        }

        function updateHistoryDisplay() {
            const history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            
            if (history.length === 0) {
                historyList.classList.add('hidden');
                emptyHistory.classList.remove('hidden');
                return;
            }
            
            historyList.classList.remove('hidden');
            emptyHistory.classList.add('hidden');
            
            historyList.innerHTML = history.map((item, index) => `
                <div 
                    class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 hover:shadow-md transition-all border-l-4 border-blue-400 hover:border-purple-500"
                >
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold text-gray-800 text-lg capitalize cursor-pointer flex-1" onclick="loadFromHistory(${index})">${item.word}</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-gray-500">${formatDate(item.timestamp)}</span>
                            <button 
                                onclick="deleteHistoryItem(${index}, event)"
                                class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all"
                                title="áƒ¬áƒáƒ¨áƒšáƒ"
                            >
                                <span class="text-lg">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 line-clamp-2 cursor-pointer" onclick="loadFromHistory(${index})">${item.definition.substring(0, 60)}...</p>
                </div>
            `).join('');
        }

        function loadFromHistory(index) {
            const history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            const item = history[index];
            
            if (item) {
                document.getElementById('wordInput').value = item.word;
                displayResults(item.word, {
                    definition: item.definition,
                    examples: item.examples
                });
                
                // Close history sidebar on mobile
                if (window.innerWidth < 768) {
                    toggleHistory();
                }
            }
        }

        function clearHistory() {
            if (confirm('áƒ“áƒáƒ áƒ¬áƒ›áƒ£áƒœáƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ®áƒáƒ áƒ— áƒ áƒáƒ› áƒ’áƒ¡áƒ£áƒ áƒ— áƒ˜áƒ¡áƒ¢áƒáƒ áƒ˜áƒ˜áƒ¡ áƒ¬áƒáƒ¨áƒšáƒ?')) {
                // Clear from Firebase if synced
                if (syncEnabled && userSecretCode && window.db) {
                    const historyRef = window.dbRef(window.db, `users/${userSecretCode}/history`);
                    window.dbRemove(historyRef);
                }
                // Clear local storage
                localStorage.removeItem('wordHistory');
                updateHistoryDisplay();
            }
        }

        function deleteHistoryItem(index, event) {
            event.stopPropagation(); // Prevent triggering loadFromHistory
            
            const history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            const itemToDelete = history[index];
            
            if (!itemToDelete) return;
            
            // Remove from local array
            history.splice(index, 1);
            localStorage.setItem('wordHistory', JSON.stringify(history));
            
            // Remove from Firebase if synced
            if (syncEnabled && userSecretCode && window.db) {
                const historyRef = window.dbRef(window.db, `users/${userSecretCode}/history`);
                
                // Re-sync entire history to Firebase (simplest approach)
                window.dbRemove(historyRef).then(() => {
                    if (history.length > 0) {
                        const historyObj = {};
                        history.forEach((item, idx) => {
                            historyObj[`word_${Date.now()}_${idx}`] = item;
                        });
                        window.dbSet(historyRef, historyObj);
                    }
                });
            }
            
            updateHistoryDisplay();
        }

        function toggleHistory() {
            const sidebar = document.getElementById('historySidebar');
            const overlay = document.getElementById('historyOverlay');
            
            if (sidebar.classList.contains('translate-x-full')) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'áƒáƒ®áƒšáƒáƒ®áƒáƒœ';
            if (diffMins < 60) return `${diffMins} áƒ¬áƒ£áƒ—áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;
            if (diffHours < 24) return `${diffHours} áƒ¡áƒáƒáƒ—áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;
            if (diffDays < 7) return `${diffDays} áƒ“áƒ¦áƒ˜áƒ¡ áƒ¬áƒ˜áƒœ`;
            
            return date.toLocaleDateString('ka-GE');
        }
    </script>
</body>
</html>
